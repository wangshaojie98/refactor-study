模块和函数是软件的骨肉，而API则是将骨肉连接起来的关节。易于理解和 使用的API非常重要，但同时也很难获得。随着对软件理解的加深，我会学到如 何改进API，这时我便需要对API进行重构。

 好的API会把更新数据的函数与只是读取数据的函数清晰分开。如果我看到 这两类操作被混在一起，就会用将查询函数和修改函数分离（306）将它们分 开。

如果两个函数的功能非常相似、只有一些数值不同，我可以用函数参数化 （310）将其统一。但有些参数其实只是一个标记，根据这个标记的不同，函数 会有截然不同的行为，此时最好用移除标记参数（314）将不同的行为彻底分 开。

 在函数间传递时，数据结构常会毫无必要地被拆开，我更愿意用保持对象完 整（319）将其聚拢。函数需要的一份信息，究竟何时应该作为参数传入、何时 应该调用一个函数获得，这是一个需要反复推敲的决定，推敲的过程中常常要用 到以查询取代参数（324）和以参数取代查询（327）。

 类是一种常见的模块形式。我希望尽可能保持对象不可变，所以只要有可 能，我就会使用移除设值函数（331）。当调用者要求一个新对象时，我经常需 要比构造函数更多的灵活性，可以借助以工厂函数取代构造函数（334）获得这 种灵活性。

 有时你会遇到一个特别复杂的函数，围绕着它传入传出一大堆数据。最后两 个重构手法专门用于破解这个难题。我可以用以命令取代函数（337）将这个函 数变成对象，这样对函数体使用提炼函数（106）时会更容易。如果稍后我对该 函数做了简化，不再需要将其作为命令对象了，可以用以函数取代命令（344） 再把它变回函数。

## 01 将查询函数和修改函数分离

如果遇到一个“既有返回值又有副作用”的函数，我就会试着将查询动作从修 改动作中分离出来。

下面是一条好规则：任何有返回值的函数，都不应该有看得到的副作用—— 命令与查询分离（Command-Query Separation）[mf-cqs]。

> 好的API会把更新数据的函数与只是读取数据的函数清晰分开。如果我看到 这两类操作被混在一起，就会用将查询函数和修改函数分离（306）将它们分 开。

## 02 函数参数化

如果我发现两个函数逻辑非常相似，只有一些字面量值不同，可以将其合并 成一个函数，以参数的形式传入不同的值，从而消除重复。这个重构可以使函数 更有用，因为重构后的函数还可以用于处理其他的值。

## 03 移除标记参数

“标记参数”是这样的一种参数：调用者用它来指示被调函数应该执行哪一部 分逻辑。例如，我可能有下面这样一个函数：

并非所有类似这样的参数都是标记参数。如果调用者传入的是程序中流动的 数据，这样的参数不算标记参数；只有调用者直接传入字面量值，这才是标记参 数。另外，在函数实现内部，如果参数值只是作为数据传给其他函数，这就不是 标记参数；

只有参数值影响了函数内部的控制流，这才是标记参数。 移除标记参数不仅使代码更整洁，并且能帮助开发工具更好地发挥作用。去 掉标记参数后，代码分析工具能更容易地体现出“高级”和“普通”两种预订逻辑在 使用时的区别。

 如果一个函数有多个标记参数，可能就不得不将其保留，否则我就得针对各 个参数的各种取值的所有组合情况提供明确函数。不过这也是一个信号，说明这 个函数可能做得太多，应该考虑是否能用更简单的函数来组合出完整的逻辑。

做法：

1. 针对参数的每一种可能值，新建一个明确函数。
2. 如果主函数有清晰的条件分发逻辑，可以用分解条件表达式（260）创建 明确函数；否则，可以在原函数之上创建包装函数。

## 04 保持对象完整（传递对象当做函数参数）

如果我看见代码从一个记录结构中导出几个值，然后又把这几个值一起传递 给一个函数，我会更愿意把整个记录传给这个函数，在函数体内部导出所需的 值。

## 05 以查询取代参数

动机：

​	函数的参数列表应该总结该函数的可变性，标示出函数可能体现出行为差异 的主要方式。和任何代码中的语句一样，参数列表应该尽量避免重复，并且参数 列表越短就越容易理解。

## 06 以参数取代查询

动机：

## 07 移除设置函数

动机:

​	如果为某个字段提供了设值函数，这就暗示这个字段可以被改变。如果不希 望在对象创建之后此字段还有机会被改变，那就不要为它提供设值函数（同时将 该字段声明为不可变）。这样一来，该字段就只能在构造函数中赋值，我“不想 让它被修改”的意图会更加清晰，并且可以排除其值被修改的可能性——这种可 能性往往是非常大的

**如果不能把“调用设值函数”替换为“创建一个新对象”（例如你需要更新一 个多处共享引用的对象），请放弃本重构。**

## 08 使用工厂函数代替构造函数

动机：

1. 例如，Java的构造函数只能返回当前所调用类的实例，也 就是说，

2. 我无法根据环境或参数信息返回子类实例或代理对象；

3. 构造函数的名字 是固定的，因此无法使用比默认名字更清晰的函数名；

4. 构造函数需要通过特殊的 操作符来调用（在很多语言中是new关键字），所以在要求普通函数的场合就难 以使用。 

工厂函数就不受这些限制。工厂函数的实现内部可以调用构造函数，但也可 以换成别的方式实现。

## 09 使用命令对象取代函数和函数取代命令对象

动机：

1. 一个典型的应用场景就是拆解复杂的函数。
2. 命令对象为处理复杂计算提供了强大的机制。借助命令对象，可以轻松地将 原本复杂的函数拆解为多个方法，彼此之间通过字段共享状态；拆解后的方法可 以分别调用；开始调用之前的数据状态也可以逐步构建。
3. 但这种强大是有代价 的。大多数时候，我只是想调用一个函数，让它完成自己的工作就好。
4. 如果这个 函数不是太复杂，那么命令对象可能显得费而不惠，我就应该考虑将其变回普通 的函数。

职责链：1_2_3_4_5